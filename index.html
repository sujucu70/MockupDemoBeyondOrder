<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo: Beyond Order - Gesti√≥n de Pedidos con IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .phone-screen { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        .transcript-bubble { opacity: 0; transform: translateY(20px); transition: all 0.5s ease; }
        .transcript-bubble.visible { opacity: 1; transform: translateY(0); }
        .transcript-bubble p { font-size: 0.75rem; line-height: 1rem; }
        .feature-item { display: flex; align-items: center; gap: 1rem; padding: 0.75rem 1rem; background-color: rgb(55 65 81 / 0.5); border-radius: 0.75rem; border: 1px solid transparent; opacity: 0.4; transition: all 0.5s ease; }
        .feature-item.highlighted { opacity: 1; background-color: rgb(31 41 55 / 0.7); border-color: rgb(59 130 246 / 0.5); }
        .tech-log-container { font-family: 'Roboto Mono', monospace; background-color: #000; border: 1px solid #374151; }
        .log-entry { opacity: 0; transform: translateY(15px); transition: opacity 0.3s ease, transform 0.3s ease; }
        .log-entry { font-size: 0.7rem; line-height: 1rem; }
        .log-entry.visible { opacity: 1; transform: translateY(0); }
        .phone-icon-container.speaking { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 50% { box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); } }
        .kpi-value { transition: color 0.5s ease; }
        .typing-indicator span { height: 8px; width: 8px; background-color: #9CA3AF; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .feature-item .text-gray-400 {
            font-size: 0.75rem;
            line-height: 1rem;
            transition: color 0.3s ease;
        }
        .feature-item.highlighted .text-gray-400 {
            color: #FFFFFF;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-screen-2xl mx-auto bg-gray-800 rounded-2xl p-6 md:p-8 shadow-2xl border border-gray-700">
        <div class="text-center mb-4">
            <h1 class="text-3xl md:text-4xl font-bold text-white">Demo Beyond Order</h1>
            <p class="text-lg text-gray-400 mt-2">Gesti√≥n de Pedidos ¬∑ Upselling Inteligente ¬∑ Integraci√≥n Log√≠stica</p>
        </div>

        <div id="kpi-panel" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 bg-gray-900/50 p-4 rounded-xl border border-gray-700">
            <div class="text-center"><p class="text-sm text-gray-400">Precisi√≥n de Pedidos</p><p id="kpi-accuracy" class="text-2xl font-bold text-green-400 kpi-value">--</p></div>
            <div class="text-center"><p class="text-sm text-gray-400">Tiempo de Ciclo</p><p id="kpi-cycle-time" class="text-2xl font-bold text-green-400 kpi-value">--</p></div>
            <div class="text-center"><p class="text-sm text-gray-400">Coste por Pedido</p><p id="kpi-cost" class="text-2xl font-bold text-green-400 kpi-value">--</p></div>
            <div class="text-center"><p class="text-sm text-gray-400">Satisfacci√≥n Cliente</p><p id="kpi-csat" class="text-2xl font-bold text-green-400 kpi-value">--</p></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="bg-gray-900 p-6 rounded-xl border border-gray-700 flex flex-col">
                <h2 class="text-xl font-semibold mb-4 text-center">Panel Conversacional</h2>
                <div class="bg-black rounded-3xl p-4 border-4 border-gray-700 phone-screen max-w-sm mx-auto">
                    <div class="text-center py-8">
                        <div id="phone-icon" class="w-20 h-20 bg-blue-500 rounded-full mx-auto flex items-center justify-center phone-icon-container">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" viewBox="0 0 20 20" fill="currentColor"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.518.759a11.03 11.03 0 004.28 4.28l.759-1.518a1 1 0 011.06-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" /></svg>
                        </div>
                        <p id="callerName" class="text-2xl font-semibold mt-4">Pizzer√≠a Bella Napoli</p>
                        <p id="callStatus" class="text-gray-400 mt-1">llamada entrante...</p>
                        <p id="callTimer" class="text-gray-400 mt-4 text-lg">00:00</p>
                    </div>
                </div>
                <div id="transcript-container" class="mt-6 space-y-4 flex-grow overflow-y-auto pr-2"></div>
            </div>

            <div class="bg-gray-900 p-6 rounded-xl border border-gray-700 flex flex-col">
                <h2 class="text-xl font-semibold mb-4 text-center">Proceso Multiag√©ntico</h2>
                <div id="features-list" class="space-y-3 flex-grow">
                    <div class="feature-item" data-feature-id="1">
                        <span class="text-2xl">üó£Ô∏è</span>
                        <p><strong>Agente Vocal:</strong><br>
                            <span id="agent-task-1" class="text-gray-400" data-default-text="Conversa e interpreta intenciones en lenguaje natural.">Conversa e interpreta intenciones en lenguaje natural.</span>
                        </p>
                    </div>
                    <div class="feature-item" data-feature-id="2">
                        <span class="text-2xl">üë§</span>
                        <p><strong>Agente de Identidad y Contexto:</strong><br>
                            <span id="agent-task-2" class="text-gray-400" data-default-text="Verifica la identidad del usuario y carga perfil desde sistemas internos.">Verifica la identidad del usuario y carga perfil desde sistemas internos.</span>
                        </p>
                    </div>
                    <div class="feature-item" data-feature-id="3">
                        <span class="text-2xl">üßë‚Äç‚öñÔ∏è</span>
                        <p><strong>Agente Orquestador:</strong><br>
                           <span id="agent-task-3" class="text-gray-400" data-default-text="Cerebro central que toma decisiones y dirige al resto de agentes.">Cerebro central que toma decisiones y dirige al resto de agentes.</span>
                        </p>
                    </div>
                    <div class="feature-item" data-feature-id="4">
                        <span class="text-2xl">‚öôÔ∏è</span>
                        <p><strong>Agente de Integraci√≥n:</strong><br>
                           <span id="agent-task-4" class="text-gray-400" data-default-text="Punto de contacto para todos los sistemas externos. Ejecuta consultas y transacciones.">Punto de contacto para todos los sistemas externos. Ejecuta consultas y transacciones.</span>
                        </p>
                    </div>
                    <div class="feature-item" data-feature-id="5">
                        <span class="text-2xl">‚Ü≥</span>
                        <p><strong>Gestor de Escalado Humano:</strong><br>
                            <span id="agent-task-5" class="text-gray-400" data-default-text="Gestiona el proceso de transferencia asegurando una transici√≥n de contexto fluida.">Gestiona el proceso de transferencia asegurando una transici√≥n de contexto fluida.</span>
                        </p>
                    </div>
                </div>
            </div>

            <div class="bg-gray-900 p-6 rounded-xl border border-gray-700 flex flex-col">
                <h2 class="text-xl font-semibold mb-4 text-center">Panel T√©cnico</h2>
                <div id="tech-log" class="tech-log-container p-4 rounded-lg overflow-y-auto flex-grow"></div>
            </div>
        </div>
        
        <div id="summary-container" class="mt-6 opacity-0 pointer-events-none transition-opacity duration-500">
            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-700">
                <h3 class="text-xl font-bold text-green-400 mb-4 text-center">Resultados de la Interacci√≥n</h3>
                <p id="summary-outcome" class="text-center text-lg text-gray-200 mt-2 px-4"></p>
            </div>
        </div>

        <div class="mt-8 text-center flex justify-center items-center space-x-4">
            <button id="demo-control-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full text-lg transition-all duration-300 shadow-lg">
                ‚ñ∂ Iniciar Demo
            </button>
            <a href="#" id="cta-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-8 rounded-full text-lg transition-all duration-300 shadow-lg hidden">
                Pru√©balo t√∫ mismo
            </a>
        </div>
    </div>

<script>
    const demoSteps = [
        {
            speaker: "Bot", text: "¬°Hola Marcos, bienvenido a Pizzer√≠a Bella Napoli! Veo que la √∫ltima vez pediste una Barbacoa. ¬øQuieres repetir tu pedido o prefieres probar algo nuevo?",
            features: [1, 2],
            agentTasks: { 1: "Recibe la llamada y reconoce al cliente.", 2: "Carga el historial de pedidos de 'Marcos' desde el CRM." },
            logs: ["[PBX] -> [VOCAL_AGENT] - INCOMING_CALL", "[IDENTITY_AGENT] -> [CRM_API] - POST /lookup_customer"],
            kpis: { accuracy: "98%", "cycle-time": "5 min", cost: "Alto", csat: "85%" },
            callerName: "Marcos", callStatus: "Llamada en curso"
        },
        {
            speaker: "Marcos", text: "Hola, hoy quiero pedir una pizza barbacoa.",
            features: [1, 3],
            agentTasks: { 1: "Interpreta la intenci√≥n 'realizar pedido' y la entidad 'pizza barbacoa'.", 3: "Inicia un nuevo carrito de compra y a√±ade el producto." },
            logs: ["[STT_ENGINE] -> [VOCAL_AGENT] - TRANSCRIPTION", "[VOCAL_AGENT] -> [ORCHESTRATOR_AGENT] - INTENT 'create_order'"],
            kpis: { accuracy: "98%", "cycle-time": "5 min", cost: "Bajo", csat: "88%" }
        },
        {
            speaker: "Bot", text: "¬°Marchando una Barbacoa! ¬øLa quieres mediana o familiar?",
            features: [3, 4],
            agentTasks: { 3: "Detecta que falta informaci√≥n (tama√±o) y pregunta al cliente.", 4: "Consulta el cat√°logo de productos para ver las opciones disponibles." },
            logs: ["[ORCHESTRATOR_AGENT] -> [INTEGRATION_AGENT] - GET /product_options?id=barbacoa", "[ORCHESTRATOR_AGENT] -> [TTS_ENGINE] - GENERATE_SPEECH"],
            kpis: { accuracy: "99%", "cycle-time": "4 min", cost: "Bajo", csat: "90%" }
        },
        {
            speaker: "Marcos", text: "Familiar, que hay hambre.",
            features: [1, 3],
            agentTasks: { 1: "Detecta la selecci√≥n del tama√±o 'familiar'.", 3: "Actualiza el carrito con el tama√±o y busca oportunidades de upselling." },
            logs: ["[STT_ENGINE] -> [VOCAL_AGENT] - TRANSCRIPTION", "[VOCAL_AGENT] -> [ORCHESTRATOR_AGENT] - UPDATE_CART 'size=familiar'"],
            kpis: { accuracy: "99%", "cycle-time": "4 min", cost: "Bajo", csat: "91%" }
        },
        {
            speaker: "Bot", text: "Anotado. Oye, por solo un euro m√°s le podemos poner nuestro borde relleno de queso. Le va genial a la Barbacoa.",
            features: [3, 4],
            agentTasks: { 3: "Ejecuta la estrategia de upselling programada para este producto.", 4: "Valida el precio y la disponibilidad del extra 'borde de queso'." },
            logs: ["[ORCHESTRATOR_AGENT] -> [UPSELLING_ENGINE] - GET /recommendation", "[ORCHESTRATOR_AGENT] -> [TTS_ENGINE] - GENERATE_SPEECH"],
            kpis: { accuracy: "99%", "cycle-time": "3 min", cost: "Bajo", csat: "92%" }
        },
        {
            speaker: "Marcos", text: "Venga, ponle el borde de queso.",
            features: [1, 3],
            agentTasks: { 1: "Confirma la aceptaci√≥n del upselling.", 3: "A√±ade el extra al carrito y busca oportunidades de cross-selling." },
            logs: ["[STT_ENGINE] -> [VOCAL_AGENT] - TRANSCRIPTION", "[VOCAL_AGENT] -> [ORCHESTRATOR_AGENT] - UPDATE_CART 'extra=cheese_crust'"],
            kpis: { accuracy: "99%", "cycle-time": "3 min", cost: "Bajo", csat: "93%" }
        },
        {
            speaker: "Bot", text: "¬°Perfecto! Ya tienes tu Barbacoa familiar con borde de queso. ¬øTe pongo algo para beber o alg√∫n entrante para acompa√±ar?",
            features: [3],
            agentTasks: { 3: "Ejecuta la estrategia de cross-selling (bebidas/entrantes)." },
            logs: ["[ORCHESTRATOR_AGENT] -> [TTS_ENGINE] - GENERATE_SPEECH"],
            kpis: { accuracy: "99%", "cycle-time": "3 min", cost: "Bajo", csat: "94%" }
        },
        {
            speaker: "Marcos", text: "S√≠, una botella de Coca-Cola Zero.",
            features: [1, 3],
            agentTasks: { 1: "Detecta el producto 'Coca-Cola Zero'.", 3: "A√±ade la bebida al carrito y procede al cierre del pedido." },
            logs: ["[STT_ENGINE] -> [VOCAL_AGENT] - TRANSCRIPTION", "[VOCAL_AGENT] -> [ORCHESTRATOR_AGENT] - UPDATE_CART 'item=cocacola_zero'"],
            kpis: { accuracy: "100%", "cycle-time": "2 min", cost: "Bajo", csat: "95%" }
        },
        {
            speaker: "Bot", text: "Estupendo. Repasamos: una pizza Barbacoa familiar con borde de queso por XX euros y una Coca-Cola Zero por X euros. El total es de veinti√∫n euros. ¬øEs todo correcto?",
            features: [3, 4],
            agentTasks: { 3: "Solicita el c√°lculo final del pedido.", 4: "Suma los precios de los productos en el carrito y devuelve el total." },
            logs: ["[ORCHESTRATOR_AGENT] -> [INTEGRATION_AGENT] - GET /calculate_total", "[ORCHESTRATOR_AGENT] -> [TTS_ENGINE] - GENERATE_SPEECH"],
            kpis: { accuracy: "100%", "cycle-time": "2 min", cost: "Bajo", csat: "95%" }
        },
        {
            speaker: "Marcos", text: "S√≠, todo correcto.",
            features: [1],
            agentTasks: { 1: "Recibe la confirmaci√≥n del cliente." },
            logs: ["[STT_ENGINE] -> [VOCAL_AGENT] - TRANSCRIPTION", "[VOCAL_AGENT] -> [ORCHESTRATOR_AGENT] - ORDER_CONFIRMED"],
            kpis: { accuracy: "100%", "cycle-time": "2 min", cost: "Bajo", csat: "95%" }
        },
        {
            speaker: "Bot", text: "Genial. Lo enviamos a tu direcci√≥n de siempre en la Calle del Sol, n√∫mero 14, ¬øverdad?",
            features: [2, 3],
            agentTasks: { 2: "Recupera la direcci√≥n guardada del perfil del cliente.", 3: "Pregunta al cliente para confirmar la direcci√≥n de entrega." },
            logs: ["[IDENTITY_AGENT] -> [CRM_API] - GET /customer_address", "[ORCHESTRATOR_AGENT] -> [TTS_ENGINE] - GENERATE_SPEECH"],
            kpis: { accuracy: "100%", "cycle-time": "2 min", cost: "Bajo", csat: "95%" }
        },
        {
            speaker: "Marcos", text: "Eso es.",
            features: [1, 4],
            agentTasks: { 1: "Recibe la confirmaci√≥n de la direcci√≥n.", 4: "Env√≠a el pedido al sistema de cocina/log√≠stica." },
            logs: ["[STT_ENGINE] -> [VOCAL_AGENT] - TRANSCRIPTION", "[INTEGRATION_AGENT] -> [LOGISTICS_API] - POST /new_order"],
            kpis: { accuracy: "100%", "cycle-time": "2 min", cost: "Bajo", csat: "95%" }
        },
        {
            speaker: "Bot", text: "De acuerdo. He consultado con la cocina y el repartidor calcula que llegar√° en unos 30 o 35 minutos. ¬øTe parece bien?",
            features: [3, 4],
            agentTasks: { 3: "Solicita una estimaci√≥n de entrega.", 4: "Consulta la API de log√≠stica para obtener el tiempo de entrega estimado." },
            logs: ["[ORCHESTRATOR_AGENT] -> [INTEGRATION_AGENT] - GET /delivery_time", "[ORCHESTRATOR_AGENT] -> [TTS_ENGINE] - GENERATE_SPEECH"],
            kpis: { accuracy: "100%", "cycle-time": "<2 min", cost: "Bajo", csat: "96%" }
        },
        {
            speaker: "Marcos", text: "Perfecto.",
            features: [1],
            agentTasks: { 1: "Recibe la conformidad del cliente." },
            logs: ["[STT_ENGINE] -> [VOCAL_AGENT] - TRANSCRIPTION"],
            kpis: { accuracy: "100%", "cycle-time": "<2 min", cost: "Bajo", csat: "96%" }
        },
        {
            speaker: "Bot", text: "¬°Pedido confirmado, Marcos! Por confirmar, el m√©todo de pago ser√° con tarjeta como siempre, ¬øverdad?",
            features: [2, 3],
            agentTasks: { 2: "Recupera el m√©todo de pago preferido del cliente.", 3: "Confirma el m√©todo de pago antes de finalizar." },
            logs: ["[IDENTITY_AGENT] -> [CRM_API] - GET /payment_method", "[ORCHESTRATOR_AGENT] -> [TTS_ENGINE] - GENERATE_SPEECH"],
            kpis: { accuracy: "100%", "cycle-time": "<2 min", cost: "Bajo", csat: "97%" }
        },
        {
            speaker: "Marcos", text: "S√≠, como siempre.",
            features: [1],
            agentTasks: { 1: "Recibe la confirmaci√≥n del pago." },
            logs: ["[STT_ENGINE] -> [VOCAL_AGENT] - TRANSCRIPTION"],
            kpis: { accuracy: "100%", "cycle-time": "<2 min", cost: "Bajo", csat: "97%" }
        },
        {
            speaker: "Bot", text: "Muy bien, tu pizza ya va de camino al horno. Para tu comodidad, te acabo de enviar un SMS al m√≥vil que tenemos registrado con un enlace para que puedas ver el estado de tu pedido en tiempo real. El repartidor llevar√° el dat√°fono. ¬°Muchas gracias por tu confianza y que aproveche!",
            features: [3, 4],
            agentTasks: { 3: "Instruye el env√≠o de la notificaci√≥n final.", 4: "Dispara el env√≠o de SMS con el enlace de tracking." },
            logs: ["[ORCHESTRATOR_AGENT] -> [INTEGRATION_AGENT] - SEND_SMS_NOTIFICATION", "[PBX] -> CALL_ENDED"],
            kpis: { accuracy: "100%", "cycle-time": "<2 min", cost: "Bajo", csat: "98%" },
            callStatus: "Llamada finalizada",
            summary: { 
                outcome: "Pedido completado con √©xito por voz, incluyendo upselling y cross-selling, con confirmaci√≥n omnicanal enviada al cliente para el seguimiento en tiempo real."
            }
        }
    ];

    const controlBtn = document.getElementById('demo-control-btn');
    const transcriptContainer = document.getElementById('transcript-container');
    const techLogContainer = document.getElementById('tech-log');
    const featureItems = document.querySelectorAll('.feature-item');
    const callerNameEl = document.getElementById('callerName');
    const callStatusEl = document.getElementById('callStatus');
    const callTimerEl = document.getElementById('callTimer');
    const phoneIcon = document.getElementById('phone-icon');
    const summaryContainer = document.getElementById('summary-container');
    const ctaBtn = document.getElementById('cta-btn');
    
    const kpiElements = { accuracy: document.getElementById('kpi-accuracy'), "cycle-time": document.getElementById('kpi-cycle-time'), cost: document.getElementById('kpi-cost'), csat: document.getElementById('kpi-csat') };

    let botVoice = null;
    let humanVoice = null;

    function speak(text, speaker) {
        if (!'speechSynthesis' in window) return;
        speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        
        if (speaker === 'Agente' && humanVoice) {
            utterance.voice = humanVoice;
        } else if (botVoice) {
            utterance.voice = botVoice;
        }
        
        utterance.lang = 'es-ES';
        if (speaker === 'Marcos') { // Adaptado al nuevo speaker
            utterance.pitch = 0.8; utterance.rate = 0.95;
        } else {
            utterance.pitch = 1.1;
            utterance.onstart = () => phoneIcon.classList.add('speaking');
            utterance.onend = () => phoneIcon.classList.remove('speaking');
        }
        speechSynthesis.speak(utterance);
    }

    function loadVoices() {
        const allVoices = speechSynthesis.getVoices();
        if (allVoices.length === 0) {
            speechSynthesis.onvoiceschanged = () => loadVoices();
            return;
        }

        let spanishVoices = allVoices.filter(voice => voice.lang === 'es-ES');

        if (spanishVoices.length === 0) {
            console.warn("No se encontraron voces 'es-ES'. Buscando en 'es'.");
            spanishVoices = allVoices.filter(voice => voice.lang.startsWith('es'));
        }

        if (spanishVoices.length >= 2) {
            botVoice = spanishVoices[0];
            humanVoice = spanishVoices[1];
        } else if (spanishVoices.length === 1) {
            console.warn("Solo se encontr√≥ una voz en espa√±ol. Se usar√° la misma para el bot y el agente humano.");
            botVoice = spanishVoices[0];
            humanVoice = spanishVoices[0];
        } else {
            console.error("No se encontr√≥ ninguna voz en espa√±ol en el sistema.");
        }
    }
    loadVoices();

    function startTimer() {
        let seconds = 0;
        timerInterval = setInterval(() => {
            seconds++;
            const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
            const secs = String(seconds % 60).padStart(2, '0');
            callTimerEl.textContent = `${mins}:${secs}`;
        }, 1000);
    }

    function stopTimer() { clearInterval(timerInterval); }
    
    function createTypingIndicator() {
        const bubble = document.createElement('div');
        bubble.id = 'typing-bubble';
        bubble.className = 'p-3 rounded-lg max-w-xs md:max-w-md bg-gray-700 rounded-bl-none mr-auto typing-indicator';
        bubble.innerHTML = '<span></span><span></span><span></span>';
        transcriptContainer.appendChild(bubble);
        transcriptContainer.scrollTop = transcriptContainer.scrollHeight;
        return bubble;
    }

    function createBubble(speaker, text) {
        const bubble = document.createElement('div');
        bubble.className = 'p-3 rounded-lg max-w-xs md:max-w-md transcript-bubble';
        if (speaker === 'Marcos') { // Adaptado al nuevo speaker
            bubble.classList.add('bg-blue-600', 'rounded-br-none', 'ml-auto');
            bubble.innerHTML = `<p>${text}</p>`;
        } else {
            bubble.classList.add('bg-gray-700', 'rounded-bl-none', 'mr-auto');
            bubble.innerHTML = `<p class="font-semibold text-blue-300 mb-1">${speaker}</p><p>${text}</p>`;
        }
        transcriptContainer.appendChild(bubble);
        transcriptContainer.scrollTop = transcriptContainer.scrollHeight;
        setTimeout(() => bubble.classList.add('visible'), 50);
    }
    
    function highlightFeatures(featureIds) {
        featureItems.forEach(item => {
            const itemId = parseInt(item.dataset.featureId);
            if (featureIds.includes(itemId)) item.classList.add('highlighted');
        });
    }
    
    function addLogEntry(logText, isProcessing = false) {
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        if (isProcessing) entry.id = 'processing-log';
        const timestamp = new Date().toLocaleTimeString('es-ES', { hour12: false });
        const coloredText = logText.replace(/\[([^\]]+)\]/g, (match, p1) => {
            if (p1.includes('->')) {
                 const parts = p1.split(' -> ');
                 return `<span class="text-blue-400">[${parts[0]}]</span> -&gt; <span class="text-red-400">[${parts[1]}]</span>`;
            }
            return `<span class="text-yellow-400">[${p1}]</span>`;
        });
        entry.innerHTML = `<span class="text-gray-500">${timestamp}</span> - ${coloredText}`;
        techLogContainer.appendChild(entry);
        techLogContainer.scrollTop = techLogContainer.scrollHeight;
        setTimeout(() => entry.classList.add('visible'), 50);
        return entry;
    }

    function updateKpis(kpiData) {
        if (!kpiData) return;
        Object.keys(kpiData).forEach(key => {
            if (kpiElements[key]) {
                kpiElements[key].textContent = kpiData[key];
            }
        });
    }

    function showSummary(summaryData) {
        document.getElementById('summary-outcome').textContent = summaryData.outcome;
        summaryContainer.classList.remove('opacity-0', 'pointer-events-none');
    }

    function renderStep(stepIndex) {
        const step = demoSteps[stepIndex];
        if (!step) return;

        transcriptContainer.innerHTML = '';
        featureItems.forEach(item => item.classList.remove('highlighted'));
        
        for (let i = 1; i <= 5; i++) {
            const taskSpan = document.getElementById(`agent-task-${i}`);
            if (taskSpan) {
                taskSpan.textContent = taskSpan.dataset.defaultText;
            }
        }

        if (step.agentTasks) {
            Object.keys(step.agentTasks).forEach(agentId => {
                const taskSpan = document.getElementById(`agent-task-${agentId}`);
                if (taskSpan) {
                    taskSpan.textContent = step.agentTasks[agentId];
                }
            });
        }

        updateKpis(step.kpis);

        const isBotTurn = step.speaker !== 'Marcos'; // Adaptado al nuevo speaker
        let typingIndicator, processingLog;

        if (isBotTurn) {
            typingIndicator = createTypingIndicator();
            processingLog = addLogEntry("[ORCHESTRATOR_AGENT] - PROCESSING... üß†", true);
        } else {
             createBubble(step.speaker, step.text);
             speak(step.text, step.speaker);
        }

        setTimeout(() => {
            if (isBotTurn) {
                typingIndicator.remove();
                processingLog.remove();
                createBubble(step.speaker, step.text);
                speak(step.text, step.speaker);
            }
            
            highlightFeatures(step.features);
            let logDelay = 50;
            step.logs.forEach(log => {
                setTimeout(() => addLogEntry(log), logDelay);
                logDelay += 100;
            });

            if (step.callerName) callerNameEl.textContent = step.callerName;
            if (step.callStatus) callStatusEl.textContent = step.callStatus;

        }, isBotTurn ? 1200 : 200);
    }

    function resetDemo() {
        currentStep = -1;
        speechSynthesis.cancel();
        transcriptContainer.innerHTML = '';
        techLogContainer.innerHTML = '<span class="text-gray-600">Esperando inicio de la demo...</span>';
        callerNameEl.textContent = 'Pizzer√≠a Bella Napoli';
        callStatusEl.textContent = 'llamada entrante...';
        callTimerEl.textContent = '00:00';
        controlBtn.textContent = '‚ñ∂ Iniciar Demo';
        controlBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full text-lg transition-all duration-300 shadow-lg';
        featureItems.forEach(item => item.classList.remove('highlighted'));
        phoneIcon.classList.remove('speaking');
        summaryContainer.classList.add('opacity-0', 'pointer-events-none');
        ctaBtn.classList.add('hidden');
        
        for (let i = 1; i <= 5; i++) {
            const taskSpan = document.getElementById(`agent-task-${i}`);
            if (taskSpan) {
                taskSpan.textContent = taskSpan.dataset.defaultText;
            }
        }

        updateKpis({ accuracy: '--', "cycle-time": '--', cost: '--', csat: '--' });
        stopTimer();
    }

    controlBtn.addEventListener('click', () => {
        if (currentStep === -1) {
            techLogContainer.innerHTML = '';
            currentStep++;
            controlBtn.textContent = 'Siguiente Paso ‚Üí';
            startTimer();
            renderStep(currentStep);
        } else if (currentStep < demoSteps.length - 1) {
            currentStep++;
            renderStep(currentStep);
        } else if (currentStep === demoSteps.length - 1) {
            renderStep(currentStep);
            controlBtn.textContent = 'Ver Resultados';
            currentStep++;
        } else if (currentStep === demoSteps.length) {
            showSummary(demoSteps[demoSteps.length - 1].summary);
            stopTimer();
            controlBtn.textContent = 'Reiniciar Demo';
            controlBtn.className = 'bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-full text-lg transition-all duration-300 shadow-lg';
            ctaBtn.classList.remove('hidden');
            currentStep++; 
        } else {
            resetDemo();
        }
    });

    ctaBtn.addEventListener('click', (e) => {
        e.preventDefault();
        alert('Aqu√≠ ir√≠a la acci√≥n del CTA, como abrir una nueva p√°gina de prueba.');
    });

    resetDemo();
</script>

</body>
</html>
